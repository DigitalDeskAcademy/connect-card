generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Organization entity for multi-tenant church structure
/// Represents churches that use the connect card system for member management
model Organization {
  id                    String             @id @default(uuid())
  /// Organization display name (e.g., "First Baptist Church", "Grace Community")
  name                  String
  /// URL-friendly identifier for organization
  slug                  String             @unique
  /// Organization type for business logic and access control
  type                  OrganizationType   @default(CHURCH)
  /// Business domain for email validation and branding
  domain                String?
  /// Organization website URL for branding
  website               String?
  /// Subscription status for billing and access control
  subscriptionStatus    SubscriptionStatus @default(TRIAL)
  /// Trial expiration date for access control
  trialEndsAt           DateTime?
  /// Stripe customer ID for billing
  stripeCustomerId      String?            @unique
  /// Stripe subscription ID for recurring billing
  stripeSubscriptionId  String?            @unique
  /// Subscription start date for billing cycle
  subscriptionStartDate DateTime?
  /// Subscription end date for cancellations
  subscriptionEndDate   DateTime?
  /// Organization creation timestamp
  createdAt             DateTime           @default(now())
  /// Last modification date
  updatedAt             DateTime           @updatedAt
  invitations           Invitation[]
  members               Member[]
  users                 User[]
  churchMembers         ChurchMember[]
  ghlToken              GHLToken?
  payments              Payment[]
  connectCards          ConnectCard[]
  connectCardBatches    ConnectCardBatch[]
  locations             Location[]
  prayerRequests        PrayerRequest[]
  volunteerCategories   VolunteerCategory[]
  prayerBatches         PrayerBatch[]
  dataExports           DataExport[]
  // Volunteer Onboarding System
  ministryRequirements   MinistryRequirements[]
  volunteerDocuments     VolunteerDocument[]
  backgroundCheckConfig  BackgroundCheckConfig?
  messageTemplates       MessageTemplate[]
  scanTokens             ScanToken[]
  /// Enable general volunteer automation sequence (Day 1/3/7 messages)
  /// When disabled, GENERAL volunteers are marked readyForExport immediately
  generalVolunteerAutomationEnabled Boolean @default(false)

  @@map("organization")
}

/// Physical location or campus for multi-location churches
/// Tracks different church campuses for connect card assignment and analytics
model Location {
  id             String        @id @default(uuid())
  /// Organization that owns this location
  organizationId String
  /// Location display name (e.g., "Bainbridge", "Bremerton")
  name           String
  /// URL-friendly identifier for location routing
  slug           String
  /// Active status for location management
  isActive       Boolean       @default(true)
  /// Location creation timestamp
  createdAt      DateTime      @default(now())
  /// Last update timestamp
  updatedAt      DateTime      @updatedAt
  organization       Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  connectCards       ConnectCard[]
  connectCardBatches ConnectCardBatch[]
  users              User[]
  prayerRequests     PrayerRequest[]
  prayerBatches      PrayerBatch[]

  @@unique([organizationId, slug])
  @@index([organizationId])
  @@map("location")
}

/// Organization membership for Better Auth organization plugin
model Member {
  id             String       @id @default(uuid())
  /// User ID from Better Auth
  userId         String
  /// Organization ID
  organizationId String
  /// Member role within organization (owner, admin, member)
  role           String
  /// Membership creation date
  createdAt      DateTime     @default(now())
  /// Last update timestamp
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@map("member")
}

/// Team invitation system for organization onboarding
model Invitation {
  id             String           @id @default(uuid())
  /// Recipient email address
  email          String
  /// Invited user role in organization
  role           String
  /// Assigned location for staff member (null for Account Owner/Admin with all-location access)
  locationId     String?
  /// Invitation token for secure acceptance
  token          String           @unique
  /// Invitation status
  status         InvitationStatus @default(PENDING)
  /// Token expiration date for security
  expiresAt      DateTime
  /// Organization extending the invitation
  organizationId String
  /// User who sent the invitation
  invitedBy      String
  /// User who accepted the invitation (if accepted)
  acceptedBy     String?
  /// Invitation creation timestamp
  createdAt      DateTime         @default(now())
  /// Last status update timestamp
  updatedAt      DateTime         @updatedAt
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([email, organizationId])
  @@map("invitation")
}

/// Core user entity supporting multi-tenant authentication and role-based access control
/// Integrates with Better Auth for OAuth flows and Stripe for payment processing
model User {
  id               String           @id
  /// Primary identifier for authentication and communication
  email            String           @unique
  name             String
  /// Better Auth email verification status
  emailVerified    Boolean
  /// Profile avatar URL from OAuth provider
  image            String?
  createdAt        DateTime
  updatedAt        DateTime
  /// Temporary ban expiration date
  banExpires       DateTime?
  /// Reason for account suspension
  banReason        String?
  /// Account suspension status
  banned           Boolean?
  /// Organization/Church ID for multi-tenant structure
  /// Optional initially, set after organization creation/joining
  organizationId   String?
  /// Role-based access control for multi-tenant architecture
  role             UserRole?
  /// Stripe customer ID for payment processing
  stripeCustomerId     String?  @unique
  /// Default campus/location for staff member
  defaultLocationId    String?
  /// Multi-campus access permission (for admins who need to see all locations)
  /// Account Owners: Always true (via logic, not stored)
  /// Multi-Campus Admins: Explicitly set to true
  /// Campus Admins: false (default) - restricted to defaultLocationId
  /// Staff: false (default) - restricted to defaultLocationId
  canSeeAllLocations   Boolean  @default(false)
  /// Volunteer categories this user can lead (e.g., "Kids Ministry", "Worship Team", "Hospitality")
  /// Used for assignment workflow when connect card users select specific volunteer interests
  volunteerCategories  String[] @default([])
  accounts          Account[]
  memberships       Member[]
  sessions          Session[]
  organization      Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  defaultLocation   Location?     @relation(fields: [defaultLocationId], references: [id])
  assignedPrayerRequests PrayerRequest[] @relation("AssignedPrayerRequests")
  assignedPrayerBatches  PrayerBatch[]   @relation("AssignedPrayerBatches")
  assignedConnectCards   ConnectCard[]   @relation("AssignedConnectCards")

  @@index([defaultLocationId])
  @@map("user")
}

/// Better Auth session management with security tracking and admin impersonation support
model Session {
  id                   String   @id
  token                String   @unique
  userId               String
  expiresAt            DateTime
  /// Security tracking for suspicious activity detection
  ipAddress            String?
  /// Browser/device identification for security analysis
  userAgent            String?
  createdAt            DateTime
  updatedAt            DateTime
  /// Active organization ID for multi-tenant context
  activeOrganizationId String?
  /// Admin user ID when session is impersonated for support
  impersonatedBy       String?
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

/// OAuth provider accounts (GitHub, Google, etc.) linked to user profiles
model Account {
  id                    String    @id
  userId                String
  /// Provider-specific account identifier
  accountId             String
  /// OAuth provider (github, google, etc.)
  providerId            String
  accessToken           String?
  refreshToken          String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  idToken               String?
  /// For email/password authentication
  password              String?
  createdAt             DateTime
  updatedAt             DateTime
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("account")
}

/// Email verification codes and password reset tokens
model Verification {
  id         String    @id
  /// Email address or user identifier
  identifier String
  /// Verification code or token
  value      String
  /// Security expiration for verification attempts
  expiresAt  DateTime
  createdAt  DateTime?
  updatedAt  DateTime?

  @@map("verification")
}

/// GoHighLevel OAuth token storage for API integration per organization
/// Access tokens expire after 24 hours, refresh tokens valid for 1 year
/// Supports both location-level and agency-level OAuth connections
/// Used for SMS automations triggered by connect card scanning
model GHLToken {
  id             String       @id @default(uuid())
  /// Organization this token belongs to
  organizationId String       @unique
  /// OAuth access token for GHL API calls (expires ~24 hours)
  accessToken    String
  /// OAuth refresh token to get new access tokens (expires 1 year)
  refreshToken   String
  /// Access token expiration timestamp
  expiresAt      DateTime
  /// GHL location ID for location-level OAuth (null for agency-level)
  locationId     String?
  /// GHL company ID for agency-level OAuth (null for location-level)
  companyId      String?
  /// Token scopes granted during OAuth authorization
  scopes         String[]
  /// Token creation timestamp
  createdAt      DateTime     @default(now())
  /// Last token refresh timestamp
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("ghl_token")
}

/// Upload batch for connect card processing
/// Groups cards uploaded together for batch processing and location tracking
model ConnectCardBatch {
  id             String      @id @default(cuid())
  /// Organization that owns this batch
  organizationId String
  /// Campus/location where cards were collected
  locationId     String?
  /// User who uploaded this batch
  uploadedBy     String
  /// Batch display name (e.g., "Bainbridge - Nov 4, 2025")
  name           String
  /// Number of cards in this batch (denormalized for performance)
  cardCount      Int         @default(0)
  /// Batch processing status
  status         BatchStatus @default(PENDING)
  /// Optional batch notes (e.g., "Morning Service", "Special Event")
  notes          String?
  /// When batch was created
  createdAt      DateTime    @default(now())
  /// Last update timestamp
  updatedAt      DateTime    @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  location       Location?    @relation(fields: [locationId], references: [id])
  cards          ConnectCard[]

  @@index([organizationId, status])
  @@index([organizationId, locationId])
  @@index([createdAt])
  @@map("connect_card_batch")
}

/// Connect card scanning and OCR data management
/// Stores scanned visitor cards with extracted information for follow-up
model ConnectCard {
  id               String             @id @default(uuid())
  /// Organization that owns this connect card
  organizationId   String
  /// S3/Tigris storage key for scanned card image (front side)
  imageKey         String
  /// SHA-256 hash of front image for duplicate detection
  imageHash        String?
  /// S3/Tigris storage key for back side of card (optional, for two-sided cards)
  backImageKey     String?
  /// SHA-256 hash of back image for duplicate detection
  backImageHash    String?
  /// Raw OCR text output from scanning service
  rawText          String?
  /// Structured extracted data (JSON format)
  extractedData    Json?
  /// Extracted visitor name
  name             String?
  /// Extracted email address
  email            String?
  /// Extracted phone number
  phone            String?
  /// Extracted physical address
  address          String?
  /// Prayer request or notes from card
  prayerRequest    String?
  /// Type of visit (First Time, Regular Attender, etc.)
  visitType        String?
  /// Areas of interest or ministry preferences
  interests        String[]           @default([])
  /// Specific volunteer category if "Volunteering" interest selected
  volunteerCategory String?
  /// Assigned volunteer leader for follow-up (only for non-General volunteer categories)
  assignedLeaderId  String?
  /// SMS automation workflow enabled for volunteer onboarding
  smsAutomationEnabled Boolean @default(false)
  /// Send notification message to assigned volunteer leader
  sendMessageToLeader Boolean @default(false)
  /// Send background check information to volunteer
  sendBackgroundCheckInfo Boolean @default(false)
  /// Volunteer onboarding pipeline status (Inquiry â†’ Planning Center Ready)
  volunteerOnboardingStatus VolunteerOnboardingStatus?
  /// Tracking which documents were sent (background check, policies, forms)
  volunteerDocumentsSent    Json?
  /// Scheduled orientation date for volunteer
  volunteerOrientationDate  DateTime?
  /// Timeline notes for volunteer onboarding process
  volunteerOnboardingNotes  String?
  /// Export tracking - when this card was last exported to external system
  lastExportedAt            DateTime?
  /// User who performed the last export
  lastExportedBy            String?
  /// Format of the last export (planning_center, breeze, generic)
  lastExportFormat          String?
  /// Processing status of the card
  status           ConnectCardStatus  @default(PENDING)
  /// Validation issues found during quality check (JSON array)
  validationIssues Json?
  /// Linked church member after processing
  churchMemberId   String?
  /// Campus/location where card was scanned
  locationId       String?
  /// Batch this card belongs to
  batchId          String?
  /// User who scanned the card
  scannedBy        String?
  /// When the card was scanned
  scannedAt        DateTime           @default(now())
  /// Card creation timestamp
  createdAt        DateTime           @default(now())
  /// Last update timestamp
  updatedAt        DateTime           @updatedAt
  organization     Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  churchMember     ChurchMember?      @relation(fields: [churchMemberId], references: [id])
  location         Location?          @relation(fields: [locationId], references: [id])
  batch            ConnectCardBatch?  @relation(fields: [batchId], references: [id])
  assignedLeader   User?              @relation("AssignedConnectCards", fields: [assignedLeaderId], references: [id])
  prayerRequests   PrayerRequest[]

  @@index([organizationId, status])
  @@index([organizationId, locationId])
  @@index([scannedAt])
  @@index([imageHash])
  @@index([backImageHash])
  @@index([lastExportedAt])
  @@map("connect_card")
}

/// Data export job tracking for CSV exports and future API syncs
/// Stores export history with S3 file references for re-download capability
model DataExport {
  id             String           @id @default(cuid())
  /// Organization that owns this export
  organizationId String
  /// Export format (determines column mapping)
  format         DataExportFormat
  /// Filters applied to this export (JSON: locationId, dateFrom, dateTo, onlyNew)
  filters        Json?
  /// Number of records exported
  recordCount    Int
  /// Generated filename (e.g., "connect-cards-2025-11-26.csv")
  fileName       String
  /// S3/Tigris storage key for the exported file
  fileKey        String
  /// File size in bytes
  fileSizeBytes  Int?
  /// User who initiated the export
  exportedBy     String
  /// When the export was created
  exportedAt     DateTime         @default(now())
  /// When the file was downloaded (null if not yet downloaded)
  downloadedAt   DateTime?
  /// When the export file expires and should be deleted (default: 30 days from creation)
  expiresAt      DateTime?

  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId, exportedAt])
  @@index([expiresAt])
  @@map("data_export")
}

/// Export format options for CSV generation
enum DataExportFormat {
  /// Planning Center People import format
  PLANNING_CENTER_CSV
  /// Breeze ChMS import format
  BREEZE_CSV
  /// Generic CSV with all fields
  GENERIC_CSV
}

/// Church member profiles - unified model for all people in the church system
/// Supports multiple member types: Visitors, Members, Volunteers, Staff
/// Integration-agnostic design supports GHL, direct signup, connect card scanning, etc.
model ChurchMember {
  id             String                @id @default(uuid())
  /// Organization managing this member (the church)
  organizationId String
  /// Type of member for business logic and filtering
  memberType     MemberType            @default(VISITOR)
  /// Member display name
  name           String
  /// Primary email for communication and enrollment notifications
  email          String?
  /// Member phone number
  phone          String?
  /// Physical address
  address        String?
  /// Timezone for scheduling and notifications
  timezone       String?
  /// Date of first visit to the church
  visitDate      DateTime?
  /// Date they became an official member
  memberSince    DateTime?
  /// Small group or community group ID
  smallGroupId   String?
  /// Serving team or volunteer team ID
  servingTeamId  String?
  /// CRM fields
  tags           String[]              @default([])
  customFields   Json?
  /// External system integrations (GHL, etc.)
  integrations   MemberIntegration[]
  /// CRM relationships
  notes          MemberNote[]
  appointments   Appointment[]
  messages       Message[]
  tasks          Task[]
  connectCards   ConnectCard[]
  /// Payments made by this member
  payments       Payment[]
  /// Volunteer profile (one-to-one relationship)
  volunteer      Volunteer?
  /// Document deliveries for onboarding
  documentDeliveries DocumentDelivery[]
  /// Member creation timestamp
  createdAt      DateTime              @default(now())
  /// Last profile update
  updatedAt      DateTime              @updatedAt
  organization   Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([organizationId, memberType])
  @@map("church_member")
}

/// Provider-agnostic integration tracking for church members
/// Supports multiple external systems (GHL, etc.)
/// Decouples core member data from integration-specific metadata
model MemberIntegration {
  id             String        @id @default(uuid())
  /// Member this integration belongs to
  churchMemberId String
  /// Integration provider (e.g., "ghl")
  provider       String
  /// Provider's unique identifier (GHL contactId, etc.)
  externalId     String
  /// Provider-specific metadata stored as JSON
  externalData   Json?
  /// Last successful sync timestamp
  lastSyncAt     DateTime?
  /// Integration status for monitoring
  syncStatus     String        @default("active")
  /// Integration creation timestamp
  createdAt      DateTime      @default(now())
  /// Last sync attempt timestamp
  updatedAt      DateTime      @updatedAt
  churchMember   ChurchMember  @relation(fields: [churchMemberId], references: [id], onDelete: Cascade)

  @@unique([provider, externalId])
  @@index([churchMemberId, provider])
  @@map("member_integration")
}

/// Notes and comments about church members for relationship management
model MemberNote {
  id             String       @id @default(uuid())
  /// Member this note belongs to
  churchMemberId String
  /// Organization for data isolation
  organizationId String
  /// Note content
  content        String
  /// User who created the note
  createdBy      String
  /// Note creation timestamp
  createdAt      DateTime     @default(now())
  /// Last update timestamp
  updatedAt      DateTime     @updatedAt
  churchMember   ChurchMember @relation(fields: [churchMemberId], references: [id], onDelete: Cascade)

  @@index([organizationId, churchMemberId])
  @@map("member_note")
}

/// Appointment and calendar event tracking for church members
model Appointment {
  id               String            @id @default(uuid())
  /// Member this appointment is with
  churchMemberId   String
  /// Organization for data isolation
  organizationId   String
  /// Calendar provider integration
  calendarProvider String?           // "cal.com" | "calendly" | "ghl"
  /// External calendar event ID
  externalEventId  String?
  /// Appointment title
  title            String
  /// Appointment description
  description      String?
  /// Start date and time
  startTime        DateTime
  /// End date and time
  endTime          DateTime
  /// Timezone for the appointment
  timezone         String
  /// Current appointment status
  status           AppointmentStatus @default(SCHEDULED)
  /// Location or meeting link
  location         String?
  /// Reminder sent flag
  reminderSent     Boolean           @default(false)
  /// Last sync with external calendar
  syncedAt         DateTime?
  /// Creation timestamp
  createdAt        DateTime          @default(now())
  /// Last update timestamp
  updatedAt        DateTime          @updatedAt
  churchMember     ChurchMember      @relation(fields: [churchMemberId], references: [id], onDelete: Cascade)

  @@index([organizationId, startTime])
  @@index([churchMemberId])
  @@map("appointment")
}

/// Message and communication tracking for church members
model Message {
  id             String           @id @default(uuid())
  /// Member this message is with
  churchMemberId String
  /// Organization for data isolation
  organizationId String
  /// Message direction
  direction      MessageDirection // INBOUND | OUTBOUND
  /// Communication channel
  channel        MessageChannel   // EMAIL | SMS | CHAT | CALL
  /// Message content
  content        String
  /// Current message status
  status         MessageStatus    @default(SENT)
  /// When message was sent
  sentAt         DateTime?
  /// When message was delivered
  deliveredAt    DateTime?
  /// When message was read
  readAt         DateTime?
  /// Integration provider
  provider       String?          // "ghl" | "twilio" | "sendgrid"
  /// External message ID
  externalId     String?
  /// Creation timestamp
  createdAt      DateTime         @default(now())
  /// Last update timestamp
  updatedAt      DateTime         @updatedAt
  churchMember   ChurchMember     @relation(fields: [churchMemberId], references: [id], onDelete: Cascade)

  @@index([organizationId, churchMemberId])
  @@map("message")
}

/// Task and to-do management for church members
model Task {
  id             String       @id @default(uuid())
  /// Member this task is related to
  churchMemberId String
  /// Organization for data isolation
  organizationId String
  /// Task title
  title          String
  /// Task description
  description    String?
  /// Due date for the task
  dueDate        DateTime?
  /// Task completion status
  status         TaskStatus   @default(PENDING)
  /// Task priority level
  priority       TaskPriority @default(MEDIUM)
  /// User assigned to the task
  assignedTo     String?
  /// Task completion date
  completedAt    DateTime?
  /// Creation timestamp
  createdAt      DateTime     @default(now())
  /// Last update timestamp
  updatedAt      DateTime     @updatedAt
  churchMember   ChurchMember @relation(fields: [churchMemberId], references: [id], onDelete: Cascade)

  @@index([organizationId, dueDate])
  @@index([churchMemberId])
  @@index([assignedTo])
  @@map("task")
}

// ============================================================================
// VOLUNTEER MANAGEMENT SYSTEM
// ============================================================================

/// Volunteer profile extending ChurchMember with volunteer-specific information
/// One-to-one relationship with ChurchMember (not all members are volunteers)
model Volunteer {
  id                    String                     @id @default(uuid())
  /// Reference to the church member this volunteer profile belongs to
  churchMemberId        String                     @unique
  /// Organization for multi-tenant isolation
  organizationId        String
  /// Default location for multi-campus churches
  locationId            String?
  /// Volunteer status for lifecycle management
  status                VolunteerStatus            @default(ACTIVE)
  /// Date the volunteer started serving
  startDate             DateTime                   @default(now())
  /// Date the volunteer stopped serving (if inactive)
  endDate               DateTime?
  /// Reason for leaving (if inactive)
  inactiveReason        String?
  /// Emergency contact name
  emergencyContactName  String?
  /// Emergency contact phone
  emergencyContactPhone String?
  /// Background check status for kids ministry
  backgroundCheckStatus BackgroundCheckStatus      @default(NOT_STARTED)
  /// Background check completion date
  backgroundCheckDate   DateTime?
  /// Background check expiration date (typically 2-3 years)
  backgroundCheckExpiry DateTime?
  /// Unique token for BG check self-report confirmation link
  bgCheckToken          String?                    @unique
  /// When volunteer self-reported BG check completion via confirmation link
  bgCheckConfirmedAt    DateTime?
  /// Whether volunteer is ready to be exported to ChMS (BG check done + docs sent)
  readyForExport        Boolean                    @default(false)
  /// Date when volunteer was marked ready for export
  readyForExportDate    DateTime?
  /// When onboarding documents were emailed to volunteer
  documentsSentAt       DateTime?
  /// When volunteer was exported to ChMS
  exportedAt            DateTime?
  /// General volunteer automation sequence status
  automationStatus      AutomationStatus?
  /// When automation sequence started
  automationStartedAt   DateTime?
  /// When volunteer responded to automation sequence
  automationResponseAt  DateTime?
  /// Notes about the volunteer (preferences, restrictions, etc.)
  notes                 String?
  /// Custom fields for church-specific data
  customFields          Json?
  /// Optimistic locking version for concurrent edit protection
  version               Int                        @default(0)
  /// Volunteer creation timestamp
  createdAt             DateTime                   @default(now())
  /// Last update timestamp
  updatedAt             DateTime                   @updatedAt
  /// Relations
  churchMember          ChurchMember               @relation(fields: [churchMemberId], references: [id], onDelete: Cascade)
  categories            VolunteerCategory[]
  skills                VolunteerSkill[]

  @@index([organizationId])
  @@index([organizationId, status])
  @@index([organizationId, locationId])
  @@index([backgroundCheckStatus])
  @@map("volunteer")
}

/// Volunteer category assignments - many-to-many relationship
/// Allows volunteers to serve in multiple ministry areas
/// Used to route connect card inquiries to appropriate ministry leaders
model VolunteerCategory {
  id             String                @id @default(uuid())
  /// Reference to volunteer this category assignment belongs to
  volunteerId    String
  /// Organization for multi-tenant isolation
  organizationId String
  /// Category type (greeter, usher, kids ministry, etc.)
  category       VolunteerCategoryType
  /// When this category was assigned
  assignedAt     DateTime              @default(now())
  /// User who assigned this category (if tracked)
  assignedBy     String?
  /// Notes about this specific category assignment
  notes          String?
  /// Creation timestamp
  createdAt      DateTime              @default(now())
  /// Last update timestamp
  updatedAt      DateTime              @updatedAt
  /// Relations
  volunteer      Volunteer             @relation(fields: [volunteerId], references: [id], onDelete: Cascade)
  organization   Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([volunteerId, category])
  @@index([volunteerId])
  @@index([organizationId, category])
  @@map("volunteer_category")
}

/// Serving opportunities - ministry roles that need volunteers
/// Examples: Greeter, Usher, Kids Ministry, Worship Team, Parking, Coffee/Hospitality
/// NOTE: Simplified model - shift scheduling moved to Planning Center
/// This can be repurposed as an Event model for capacity tracking
model ServingOpportunity {
  id                 String                        @id @default(uuid())
  /// Organization for multi-tenant isolation
  organizationId     String
  /// Location for multi-campus churches (null = all locations)
  locationId         String?
  /// Opportunity name (e.g., "Sunday Greeter", "Kids Ministry Helper")
  name               String
  /// Detailed description of the role
  description        String?
  /// Ministry or team category (e.g., "Hospitality", "Kids Ministry")
  category           String?
  /// Number of volunteers needed per service/event
  volunteersNeeded   Int                           @default(1)
  /// Day of week for regular opportunities (0=Sunday, 6=Saturday, null=varies)
  dayOfWeek          Int?
  /// Service time or time slot
  serviceTime        String?
  /// Duration in minutes (e.g., 120 for 2-hour shift)
  durationMinutes    Int?
  /// Whether this opportunity is active and accepting volunteers
  isActive           Boolean                       @default(true)
  /// Whether this is a recurring opportunity (weekly, bi-weekly)
  isRecurring        Boolean                       @default(true)
  /// Sort order for display
  sortOrder          Int                           @default(0)
  /// Custom fields for church-specific data
  customFields       Json?
  /// Optimistic locking version for concurrent edit protection
  version            Int                           @default(0)
  /// Creation timestamp
  createdAt          DateTime                      @default(now())
  /// Last update timestamp
  updatedAt          DateTime                      @updatedAt

  @@index([organizationId])
  @@index([organizationId, isActive])
  @@index([organizationId, locationId])
  @@index([organizationId, category])
  @@map("serving_opportunity")
}

/// Skills and qualifications volunteers can have
/// Examples: "Background Check Cleared", "Musical Ability", "CPR Certified"
model VolunteerSkill {
  id             String   @id @default(uuid())
  /// Volunteer this skill belongs to
  volunteerId    String
  /// Skill name or qualification
  skillName      String
  /// Skill level or proficiency (beginner, intermediate, advanced)
  proficiency    String?
  /// Whether this skill is verified/certified
  isVerified     Boolean  @default(false)
  /// Verification date
  verifiedDate   DateTime?
  /// Expiration date for time-limited certifications
  expiryDate     DateTime?
  /// Notes about this skill
  notes          String?
  /// Creation timestamp
  createdAt      DateTime @default(now())
  /// Last update timestamp
  updatedAt      DateTime @updatedAt
  /// Relations
  volunteer      Volunteer @relation(fields: [volunteerId], references: [id], onDelete: Cascade)

  @@index([volunteerId])
  @@index([skillName])
  @@map("volunteer_skill")
}

// ============================================================================
// REMOVED: Shift Scheduling Models (Dec 2025)
// ServingOpportunitySkill, VolunteerAvailability, VolunteerShift moved to Planning Center
// ============================================================================

// ============================================================================
// VOLUNTEER MANAGEMENT ENUMS
// ============================================================================

/// Volunteer lifecycle status
enum VolunteerStatus {
  /// Volunteer is actively serving
  ACTIVE
  /// Volunteer is on temporary break (sabbatical, personal reasons)
  ON_BREAK
  /// Volunteer is no longer serving
  INACTIVE
  /// Volunteer application pending approval
  PENDING_APPROVAL
}

/// Background check status for kids ministry and sensitive roles
enum BackgroundCheckStatus {
  /// Background check not yet initiated
  NOT_STARTED
  /// Background check in progress
  IN_PROGRESS
  /// Volunteer self-reported completion, awaiting staff verification
  PENDING_REVIEW
  /// Background check completed and passed
  CLEARED
  /// Background check failed or flagged
  FLAGGED
  /// Background check expired and needs renewal
  EXPIRED
}

/// General volunteer automation sequence status
/// Tracks progress through the Day 1/3/7 automation workflow
enum AutomationStatus {
  /// Queued for Day 1 welcome message
  PENDING
  /// Day 1 welcome sent, waiting for response
  DAY1_SENT
  /// Day 3 follow-up sent, waiting for response
  DAY3_SENT
  /// Volunteer responded to automation sequence
  RESPONDED
  /// Day 7 timeout reached, exported to ChMS general
  EXPIRED
}

/// Volunteer onboarding pipeline status
/// Tracks progress from inquiry to Planning Center ready
enum VolunteerOnboardingStatus {
  /// Initial volunteer interest expressed
  INQUIRY
  /// Welcome message sent to volunteer
  WELCOME_SENT
  /// Ministry documents shared (background check, policies, forms)
  DOCUMENTS_SHARED
  /// Introduced to volunteer leader
  LEADER_CONNECTED
  /// Orientation scheduled
  ORIENTATION_SET
  /// Ready to be added to Planning Center
  READY
  /// Exported to Planning Center (final state)
  ADDED_TO_PCO
}

/// Volunteer category types for ministry assignment routing
/// Used to route connect card inquiries to appropriate ministry leaders
enum VolunteerCategoryType {
  /// General volunteer (default category for new volunteers)
  GENERAL
  /// Sunday morning greeter
  GREETER
  /// Usher for seating and offering
  USHER
  /// Kids ministry volunteer (requires background check)
  KIDS_MINISTRY
  /// Worship team musician or vocalist
  WORSHIP_TEAM
  /// Parking lot attendant
  PARKING
  /// Coffee and hospitality
  HOSPITALITY
  /// Audio/visual technician
  AV_TECH
  /// Prayer team member
  PRAYER_TEAM
  /// Other ministry not listed above
  OTHER
}

// REMOVED: AvailabilityType, RecurrencePattern, ShiftStatus enums (Dec 2025)
// Shift scheduling moved to Planning Center

/// Organization types for business logic and access control
enum OrganizationType {
  /// Platform organization
  PLATFORM
  /// Individual church organization
  CHURCH
  /// Multi-church network or denomination
  NETWORK
}

/// Subscription status for billing and access control
enum SubscriptionStatus {
  /// Free trial period
  TRIAL
  /// Active paid subscription
  ACTIVE
  /// Payment past due
  PAST_DUE
  /// Subscription cancelled
  CANCELLED
  /// Account suspended
  SUSPENDED
}

/// Invitation lifecycle states
enum InvitationStatus {
  /// Invitation sent, awaiting response
  PENDING
  /// Invitation accepted by recipient
  ACCEPTED
  /// Invitation declined by recipient
  DECLINED
  /// Invitation expired or revoked
  EXPIRED
}

/// User roles for multi-tenant access control and business logic
enum UserRole {
  /// Platform administrators (employees)
  platform_admin
  /// Church owner (primary account holder, billing admin)
  church_owner
  /// Church team member (can manage content and members)
  church_admin
  /// Volunteer leader (can view and manage their team)
  volunteer_leader
  /// End user/client (matches Better Auth's default "user")
  user
}

/// Member types for categorizing people in the church system
enum MemberType {
  /// First-time visitor to the church
  VISITOR
  /// Returning visitor (not yet a member)
  RETURNING
  /// Committed church member
  MEMBER
  /// Active volunteer serving in ministry
  VOLUNTEER
  /// Paid church staff member
  STAFF
}

/// Connect card processing status
enum ConnectCardStatus {
  /// Card scanned, awaiting OCR processing
  PENDING
  /// OCR completed, data extracted
  EXTRACTED
  /// Staff reviewed and verified data
  REVIEWED
  /// Member created/updated from card data
  PROCESSED
  /// Card rejected (duplicate, illegible, etc.)
  REJECTED
}

/// Batch processing status
enum BatchStatus {
  /// Cards uploaded, awaiting review
  PENDING
  /// Batch currently being reviewed
  IN_REVIEW
  /// All cards reviewed and processed
  COMPLETED
  /// Batch archived for historical records
  ARCHIVED
}

/// Appointment status tracking
enum AppointmentStatus {
  /// Appointment is scheduled
  SCHEDULED
  /// Appointment is confirmed
  CONFIRMED
  /// Appointment was completed
  COMPLETED
  /// Appointment was cancelled
  CANCELLED
  /// Member was a no-show
  NO_SHOW
}

/// Message direction for communication tracking
enum MessageDirection {
  /// Message received from member
  INBOUND
  /// Message sent to member
  OUTBOUND
}

/// Communication channels for messages
enum MessageChannel {
  /// Email communication
  EMAIL
  /// SMS text message
  SMS
  /// Chat/instant message
  CHAT
  /// Phone call
  CALL
  /// Social media message
  SOCIAL
}

/// Message delivery status
enum MessageStatus {
  /// Message sent
  SENT
  /// Message delivered
  DELIVERED
  /// Message read/opened
  READ
  /// Message failed to send
  FAILED
  /// Message bounced
  BOUNCED
}

/// Task status tracking
enum TaskStatus {
  /// Task is pending
  PENDING
  /// Task in progress
  IN_PROGRESS
  /// Task completed
  COMPLETED
  /// Task cancelled
  CANCELLED
}

/// Task priority levels
enum TaskPriority {
  /// Low priority
  LOW
  /// Medium priority
  MEDIUM
  /// High priority
  HIGH
  /// Urgent priority
  URGENT
}

/// Payment transaction entity for tracking donations and member payments
/// Synced from GoHighLevel via webhooks when payments are collected
model Payment {
  id              String        @id @default(cuid())
  /// Organization that received this payment
  organizationId  String
  /// GoHighLevel payment/invoice ID for sync reference
  ghlPaymentId    String?       @unique
  /// GoHighLevel contact ID for member reference (stored for sync)
  ghlContactId    String?
  /// Internal member ID (optional - linked after member sync)
  churchMemberId  String?
  /// Stripe payment intent ID if available
  stripePaymentId String?

  /// Member information (denormalized for performance)
  memberName  String?
  memberEmail String?
  memberPhone String?

  /// Payment details
  amount        Decimal       @db.Decimal(10, 2)
  /// Payment status
  status        PaymentStatus @default(PENDING)
  /// Payment method used (card, cash, etc)
  paymentMethod String?
  /// Invoice/receipt number
  invoiceNumber String?
  /// Payment description/notes
  description   String?

  /// Timestamps
  paidAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  /// Relations
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  churchMember ChurchMember? @relation(fields: [churchMemberId], references: [id])

  @@index([organizationId, status])
  @@index([ghlPaymentId])
  @@index([paidAt])
  @@map("payment")
}

/// Prayer request tracking and management for church prayer ministry
/// Supports privacy controls, team assignments, and follow-up tracking
model PrayerRequest {
  id             String              @id @default(uuid())
  /// Organization that owns this prayer request
  organizationId String
  /// Campus/location where request originated (null for multi-campus requests)
  locationId     String?

  /// Request details
  /// Full prayer request text (max 2000 characters)
  request        String              @db.Text
  /// Prayer category for filtering and reporting
  category       String?
  /// Privacy flag - true = only visible to assigned team and admins
  isPrivate      Boolean             @default(false)
  /// Urgency flag for priority requests
  isUrgent       Boolean             @default(false)

  /// Source tracking
  /// Link to originating connect card (if from card scan)
  connectCardId  String?
  /// Prayer batch this request belongs to
  prayerBatchId  String?
  /// Name of person submitting request (if not from connect card)
  submittedBy    String?
  /// Submitter email for follow-up communication
  submitterEmail String?
  /// Submitter phone for follow-up communication
  submitterPhone String?

  /// Assignment and tracking
  /// Current workflow status
  status         PrayerRequestStatus @default(PENDING)
  /// User ID of assigned prayer team member
  assignedToId   String?
  /// Denormalized name for display (performance optimization)
  assignedToName String?
  /// Follow-up date scheduled
  followUpDate   DateTime?
  /// Date prayer was answered
  answeredDate   DateTime?
  /// Testimony or notes about answered prayer
  answeredNotes  String?             @db.Text

  /// Timestamps
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  /// Relations
  organization   Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  location       Location?           @relation(fields: [locationId], references: [id], onDelete: SetNull)
  connectCard    ConnectCard?        @relation(fields: [connectCardId], references: [id], onDelete: SetNull)
  prayerBatch    PrayerBatch?        @relation(fields: [prayerBatchId], references: [id], onDelete: SetNull)
  assignedTo     User?               @relation("AssignedPrayerRequests", fields: [assignedToId], references: [id], onDelete: SetNull)

  @@index([organizationId, createdAt])
  @@index([organizationId, locationId])
  @@index([organizationId, status])
  @@index([prayerBatchId])
  @@index([assignedToId])
  @@map("prayer_request")
}

/// Payment transaction status
enum PaymentStatus {
  /// Payment pending/processing
  PENDING
  /// Payment completed successfully
  PAID
  /// Payment failed
  FAILED
  /// Payment refunded
  REFUNDED
  /// Payment partially refunded
  PARTIALLY_REFUNDED
}

/// Prayer request status for tracking workflow
enum PrayerRequestStatus {
  /// Newly submitted, needs review or assignment
  PENDING
  /// Assigned to prayer team member
  ASSIGNED
  /// Actively being prayed for
  PRAYING
  /// Prayer answered, marked complete
  ANSWERED
  /// Archived (no longer active)
  ARCHIVED
}

/// Prayer batch for grouping daily prayer requests
/// Groups prayers collected on a specific day for assignment to prayer team
model PrayerBatch {
  id             String      @id @default(cuid())
  /// Organization that owns this batch
  organizationId String
  /// Campus/location where prayers originated (null for multi-campus batches)
  locationId     String?
  /// Batch display name (e.g., "Monday Nov 18, 2025 Prayers")
  name           String
  /// Date this batch represents (for daily grouping)
  batchDate      DateTime
  /// Prayer team member assigned to this batch
  assignedToId   String?
  /// Denormalized name for display (performance optimization)
  assignedToName String?
  /// Number of prayers in this batch (denormalized for performance)
  prayerCount    Int         @default(0)
  /// Batch processing status
  status         BatchStatus @default(PENDING)
  /// Date when batch was completed (all prayers marked as prayed)
  completedAt    DateTime?
  /// Optional batch notes
  notes          String?
  /// Batch creation timestamp
  createdAt      DateTime    @default(now())
  /// Last update timestamp
  updatedAt      DateTime    @updatedAt
  /// Relations
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  location       Location?    @relation(fields: [locationId], references: [id])
  assignedTo     User?        @relation("AssignedPrayerBatches", fields: [assignedToId], references: [id], onDelete: SetNull)
  prayerRequests PrayerRequest[]

  @@index([organizationId, status])
  @@index([organizationId, locationId])
  @@index([organizationId, batchDate])
  @@index([batchDate])
  @@map("prayer_batch")
}

// ============================================================================
// VOLUNTEER ONBOARDING SYSTEM
// ============================================================================

/// Document scope for volunteer documents
enum DocumentScope {
  /// Applies to all volunteers
  GLOBAL
  /// Applies to specific ministry category
  MINISTRY_SPECIFIC
}

/// Document delivery method
enum DeliveryMethod {
  /// Sent via email
  EMAIL
  /// SMS with document link
  SMS_LINK
  /// Included in welcome packet
  WELCOME_PACKET
}

/// Background check provider options
enum BGCheckProvider {
  /// Protect My Ministry
  PROTECT_MY_MINISTRY
  /// Sterling Volunteers
  STERLING_VOLUNTEERS
  /// Ministry Safe
  MINISTRY_SAFE
  /// Checkr
  CHECKR
  /// Custom provider
  CUSTOM
}

/// Background check payment model
enum BGCheckPayment {
  /// Church pays for background check
  CHURCH_PAID
  /// Volunteer pays for background check
  VOLUNTEER_PAID
}

/// Ministry requirements configuration per category
/// Defines what each ministry category requires for volunteers
model MinistryRequirements {
  id                       String                @id @default(cuid())
  organizationId           String
  category                 VolunteerCategoryType
  backgroundCheckRequired  Boolean               @default(false)
  backgroundCheckValidMonths Int?                @default(24)
  trainingRequired         Boolean               @default(false)
  trainingDescription      String?
  trainingUrl              String?
  customRequirements       Json?
  isActive                 Boolean               @default(true)
  sortOrder                Int                   @default(0)
  createdAt                DateTime              @default(now())
  updatedAt                DateTime              @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, category])
  @@index([organizationId])
  @@map("ministry_requirements")
}

/// Volunteer document storage and tracking
/// Stores documents to share with volunteers during onboarding
model VolunteerDocument {
  id              String                 @id @default(cuid())
  organizationId  String
  name            String
  fileName        String
  /// S3 key (path) for the document - construct URL via getDocumentUrl() helper
  /// Legacy data may contain full URLs which are handled gracefully
  fileKey         String
  fileSize        Int
  mimeType        String
  scope           DocumentScope          @default(GLOBAL)
  category        VolunteerCategoryType?
  description     String?
  isTemplate      Boolean                @default(false)
  version         Int                    @default(1)
  uploadedBy      String?
  uploadedAt      DateTime               @default(now())
  updatedAt       DateTime               @updatedAt

  organization Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  deliveries   DocumentDelivery[]

  @@index([organizationId])
  @@index([organizationId, scope])
  @@index([organizationId, category])
  @@map("volunteer_document")
}

/// Track document delivery to volunteers
model DocumentDelivery {
  id           String         @id @default(cuid())
  documentId   String
  volunteerId  String
  method       DeliveryMethod
  sentAt       DateTime       @default(now())
  openedAt     DateTime?
  downloadedAt DateTime?

  document  VolunteerDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  volunteer ChurchMember      @relation(fields: [volunteerId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([volunteerId])
  @@map("document_delivery")
}

/// Background check provider configuration per organization
model BackgroundCheckConfig {
  id                String         @id @default(cuid())
  organizationId    String         @unique
  provider          BGCheckProvider
  providerAccountId String?
  applicationUrl    String?
  validityMonths    Int            @default(24)
  paymentModel      BGCheckPayment @default(CHURCH_PAID)
  reminderDays      Int[]          @default([30, 7])
  instructions      String?
  isEnabled         Boolean        @default(false)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@map("background_check_config")
}

/// Message template for volunteer communications
model MessageTemplate {
  id              String   @id @default(cuid())
  organizationId  String
  name            String
  subject         String?
  body            String
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@map("message_template")
}

// ============================================================================
// EMAIL AUDIT LOG
// ============================================================================

/// Email delivery audit log for tracking all outbound emails
/// Supports retry logic, debugging, and compliance requirements
model EmailLog {
  id             String      @id @default(cuid())
  /// Organization for multi-tenant isolation (optional for system emails)
  organizationId String?
  /// Recipient email address
  to             String
  /// Sender email address
  from           String
  /// Email subject line
  subject        String
  /// Delivery status
  status         EmailStatus @default(PENDING)
  /// Resend message ID (if sent via Resend)
  resendId       String?
  /// Error message if delivery failed
  error          String?
  /// Additional metadata (JSON: templateName, volunteerId, etc.)
  metadata       Json?
  /// When email was actually sent (null if not sent)
  sentAt         DateTime?
  /// When this log entry was created
  createdAt      DateTime    @default(now())

  @@index([organizationId])
  @@index([organizationId, status])
  @@index([to])
  @@index([createdAt])
  @@map("email_log")
}

/// Email delivery status for audit logging
enum EmailStatus {
  /// Email queued but not yet processed
  PENDING
  /// Email successfully sent to provider
  SENT
  /// Email delivery failed
  FAILED
  /// Email skipped (dev mode, invalid recipient, etc.)
  SKIPPED
}

// ============================================================================
// QR CODE SCAN TOKENS
// ============================================================================

/// Temporary token for QR code-based mobile scanning
/// Allows phone to scan cards without re-authenticating
model ScanToken {
  id             String    @id @default(cuid())
  /// Unique token for URL
  token          String    @unique
  /// User who created the token
  userId         String
  /// Organization scope
  organizationId String
  /// Token expiration time (15 minutes from creation)
  expiresAt      DateTime
  /// When token was used (null if not yet used, for single-use enforcement)
  usedAt         DateTime?
  /// When token was created
  createdAt      DateTime  @default(now())

  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId, organizationId])
  @@index([expiresAt])
  @@map("scan_token")
}
